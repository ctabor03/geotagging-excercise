<script>
  /* ==================== INIT MAP ==================== */
  const map = L.map("map", {
    zoomControl: true,
    maxBoundsViscosity: 1.0
  }).setView([10.6685, 122.9647], 15);

  /* Satellite Layer */
  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 19 }
  ).addTo(map);

  /* ==================== VILLAMONTE BOUNDARY ==================== */
  const villamonteCoords = [
    [10.6760,122.9530],
    [10.6760,122.9770],
    [10.6590,122.9770],
    [10.6590,122.9530]
  ];

  const villamontePoly = L.polygon(villamonteCoords, {
    color: "#ff0000", weight: 2, fillOpacity: 0
  }).addTo(map);

  map.fitBounds(villamontePoly.getBounds());
  map.setMaxBounds(villamontePoly.getBounds());

  /* ==================== DARK MASK OUTSIDE ==================== */
  const world = [
    [-90, -180], [-90, 180], [90, 180], [90, -180]
  ];

  L.polygon([world, villamonteCoords], {
    color: "#000",
    fillOpacity: 0.60,
    stroke: false
  }).addTo(map);

  /* ==================== STI WEST NEGROS UNIVERSITY — PERMANENT MARKER ==================== */
  const stiLat = 10.669309973518835;
  const stiLng = 122.95691342250888;

  const permanentMarker = L.marker([stiLat, stiLng], {
    draggable: false
  }).addTo(map);

  permanentMarker.bindPopup("<b>STI West Negros University</b>");
  permanentMarker.on("click", () => permanentMarker.openPopup());

  /* ==================== MULTIPLE USER PINS ==================== */
  let userPins = [];     // final permanent pins
  let tempPin = null;    // temporary pin before submit
  let pinMode = false;

  function enablePinMode() {
    pinMode = true;
    alert("Tap inside Barangay Villamonte to place a pin.");
  }

  map.on("click", function(e) {
    if (!pinMode) return;

    if (!villamontePoly.getBounds().contains(e.latlng)) {
      alert("Please tap inside Villamonte.");
      return;
    }

    // Remove previous temp pin if exists
    if (tempPin) map.removeLayer(tempPin);

    // Create temporary pin
    tempPin = L.marker(e.latlng, { draggable: false }).addTo(map);

    pinMode = false;
  });

  /* ==================== SUBmission ==================== */
  function submitLocation() {
    const name = document.getElementById("placeName").value.trim();
    const address = document.getElementById("placeAddress").value.trim();

    if (!tempPin) {
      alert("Please place a pin first.");
      return;
    }
    if (!name || !address) {
      alert("Enter both the name and address.");
      return;
    }

    const pos = tempPin.getLatLng();

    /* Convert temp pin → permanent labeled pin */
    tempPin.bindPopup(`<b>${name}</b><br>${address}<br>
      <small>${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}</small>`);

    tempPin.on("click", () => tempPin.openPopup());

    userPins.push(tempPin);

    // Show confirmation text below
    document.getElementById("result").innerHTML = `
      <b>Pin Saved:</b> ${name}<br>
      <i>Tap the marker on the map to view its label.</i>
    `;

    // Reset form + tempPin
    tempPin = null;
    document.getElementById("placeName").value = "";
    document.getElementById("placeAddress").value = "";
  }
</script>
